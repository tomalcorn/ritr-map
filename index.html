<!DOCTYPE html>
<html>
<head>
    <title>Map Sticker Placer</title>
    <style>
        #map-container {
            position: relative;
            display: inline-block;
        }
        .sticker {
            position: absolute;
            width: 30px;
            height: 30px;
            transform: translate(-50%, -50%);
            background-color: red;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <img id="map" src="/static/map.jpg" style="max-width: 800px;">
    </div>

    <script>
        const mapContainer = document.getElementById('map-container');
        const scaleX = 0.301;
        const scaleY = 0.302;
        const offsetX = 18;
        const offsetY = 15;
        let planets = {};

        fetch('/static/planets.json')
            .then(response => response.json())
            .then(data => {
                planets = data;
            });

        mapContainer.onclick = function(e) {
            // Remove any existing selection boxes or circles
            const existingBox = document.querySelector('.sticker-selection-box');
            if (existingBox) existingBox.remove();
            const existingCircles = document.querySelectorAll('.glow-circle');
            existingCircles.forEach(circle => circle.remove());

            const rect = mapContainer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const closestPlanet = findClosestPlanet(x, y);
            
            if (closestPlanet) {
                createStickerSelectionBox(closestPlanet);
            }
        };

        function findClosestPlanet(clickX, clickY, maxDistance = 50) {
            for (const [name, planet] of Object.entries(planets)) {
                const scaledX = planet.x * scaleX + offsetX;
                const scaledY = planet.y * scaleY + offsetY;
                
                const distance = Math.sqrt(
                    Math.pow(clickX - scaledX, 2) + 
                    Math.pow(clickY - scaledY, 2)
                );
                
                if (distance <= maxDistance) {
                    return { name, ...planet };
                }
            }
            return null;
        }

        function createStickerSelectionBox(planet) {
            const box = document.createElement('div');
            box.className = 'sticker-selection-box';
            box.style.position = 'absolute';
            box.style.border = '1px solid black';
            box.style.backgroundColor = 'white';
            box.style.padding = '10px';
            box.style.display = 'flex';
            box.style.gap = '10px';

            const scaledX = planet.x * scaleX + offsetX;
            const scaledY = planet.y * scaleY + offsetY;

            box.style.left = `${scaledX + 20}px`;
            box.style.top = `${scaledY}px`;

            // Create a glowing circle around the planet
            const glowCircle = document.createElement('div');
            glowCircle.className = 'glow-circle';
            glowCircle.style.position = 'absolute';
            glowCircle.style.width = '30px';   // Adjust size as needed
            glowCircle.style.height = '30px';
            glowCircle.style.borderRadius = '50%';
            glowCircle.style.border = '2px solid yellow';
            glowCircle.style.boxShadow = '0px 0px 15px 5px yellow';
            glowCircle.style.left = `${scaledX - 17}px`;  // Centered around planet
            glowCircle.style.top = `${scaledY - 16}px`;
            
            mapContainer.appendChild(glowCircle);

            const stickers = [
                { name: 'Neutral', path: '/static/stickers/neutral.png' },
                { name: 'Empire Base', path: '/static/stickers/empire_base.png' },
                { name: 'Empire Presence', path: '/static/stickers/empire_pres.png' },
                { name: 'Rebel Base', path: '/static/stickers/rebel_base.png' },
                { name: 'Rebel Presence', path: '/static/stickers/rebel_pres.png' }
            ];

            stickers.forEach(stickerType => {
                const stickerWrapper = document.createElement('div');
                stickerWrapper.style.display = 'flex';
                stickerWrapper.style.flexDirection = 'column';
                stickerWrapper.style.alignItems = 'center';
                stickerWrapper.style.width = '30px';  // Fixed width to maintain uniform layout

                const stickerOption = document.createElement('img');
                stickerOption.src = stickerType.path;
                stickerOption.style.width = '30px';
                stickerOption.style.height = '30px';
                stickerOption.style.cursor = 'pointer';

                stickerOption.onclick = () => {
                    updatePlanetSticker(planet.name, stickerType.name.toLowerCase().replace(" ", "_"));

                    const existingSticker = document.querySelector(`[data-planet="${planet.name}"]`);
                    if (existingSticker) {
                        existingSticker.remove();
                    }

                    if (stickerType.name.toLowerCase() !== 'neutral') {
                        const newSticker = document.createElement('img');
                        newSticker.src = stickerType.path;
                        newSticker.className = 'planet-sticker';
                        newSticker.dataset.planet = planet.name;
                        newSticker.style.position = 'absolute';
                        newSticker.style.width = '30px';
                        newSticker.style.height = '30px';
                        newSticker.style.left = `${scaledX - 15}px`;
                        newSticker.style.top = `${scaledY - 15}px`;
                        mapContainer.appendChild(newSticker);
                    }

                    box.remove();
                    glowCircle.remove(); // Remove glow when selection box closes
                };

                const stickerLabel = document.createElement('div');
                stickerLabel.textContent = stickerType.name;
                stickerLabel.style.fontSize = '10px';
                stickerLabel.style.textAlign = 'center';
                stickerLabel.style.fontFamily = '"Gill Sans", sans-serif'; // change font here

                stickerWrapper.appendChild(stickerOption);
                stickerWrapper.appendChild(stickerLabel);
                box.appendChild(stickerWrapper);
            });

            mapContainer.appendChild(box);
        }

        function updatePlanetSticker(planetName, stickerType) {
            fetch('/update_planet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    planet: planetName,
                    status: stickerType
                })
            });
        }
    </script>
</body>
</html>