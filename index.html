<!DOCTYPE html>
<html>
<head>
    <title>RITR Interactive Map</title>
    <style>
        #container {
            display: flex;
        }
        #map-container {
            position: relative;
            display: inline-block;
        }
        #page-title {
            font-family: "Gill Sans", sans-serif; /* âœ… Fixed */
            text-align: center;
            font-size: 24px;
            margin-bottom: 10px;
        }
        #sidebar {
            display: inline-block;
            margin-left: 20px; /* Space between map and sidebar */
            padding: 10px;
            border: 1px solid black;
            background-color: #f4f4f4;
            min-width: 240px; /* Sidebar width */
        }

        #clear-stickers-btn {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
            background-color: red;
            color: white;
            border: none;
            border-radius: 5px;
        }
        #lock-map-btn {
            margin-top: 10px;
            width: 100%;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
            background-color: grey;
            color: white;
            border: none;
            border-radius: 5px;
        }

        #clear-stickers-btn:hover {
            background-color: darkred;
        }
    </style>
</head>
<body>
    <h1 id="page-title">
        Star Wars Armada: Rebellion in the Rim <br> Interactive Map
    </h1>
    
    <!-- Parent Flex Container -->
    <div id="container">
        <!-- Map Container -->
        <div id="map-container">
            <img id="map" src="/static/map.jpg" style="max-width: 900px;">
        </div>

        <!-- Sidebar -->
        <div id="sidebar">
            <button id="clear-stickers-btn">Clear Stickers</button>
            <button id="lock-map-btn">Lock Map</button>
        </div>

    <script>
        
        const lockButton = document.getElementById('lock-map-btn');
        const mapContainer = document.getElementById('map-container');
        const scaleX = 0.339;
        const scaleY = 0.3396;
        const offsetX = 20.15;
        const offsetY = 16.875;
        let planets = {};

        let isLocked = false; // Default: map is interactive

        lockButton.addEventListener('click', () => {
            isLocked = !isLocked; // Toggle state

            if (isLocked) {
                mapContainer.style.pointerEvents = 'none'; // Disable interactions
                lockButton.textContent = 'Unlock Map';
            } else {
                mapContainer.style.pointerEvents = 'auto'; // Enable interactions
                lockButton.textContent = ' Lock Map ';
            }

            // Save the lock state to the backend
            saveLockState(isLocked);
        });

        // Function to send lock state to the backend
        function saveLockState(locked) {
            fetch('/update-lock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ locked })
            });
        }

        // Function to load lock state on page load
        async function loadLockState() {
            const response = await fetch('/get-lock');
            const data = await response.json();
            isLocked = data.locked;

            mapContainer.style.pointerEvents = isLocked ? 'none' : 'auto';
            lockButton.textContent = isLocked ? 'Unlock Map' : 'Lock Map';
        }

        // Load state when the page loads
        window.addEventListener('load', loadLockState);

        // Load initial stickers when page loads
        fetch('/static/planets.json')
            .then(response => response.json())
            .then(data => {
                planets = data;
                Object.entries(planets).forEach(([name, planet]) => {
                    if (planet.status !== 'neutral') {
                        displaySticker(name, planet);
                    }
                });
            });
        
        // TODO: Fix so clearing stickers also updates backend
        document.getElementById('clear-stickers-btn').addEventListener('click', () => {
        // Remove all sticker elements from the DOM
        document.querySelectorAll('.planet-sticker').forEach(sticker => sticker.remove());
        })

        mapContainer.onclick = function(e) {
            // Remove any existing selection boxes or circles
            const existingBox = document.querySelector('.sticker-selection-box');
            if (existingBox) existingBox.remove();
            const existingCircles = document.querySelectorAll('.glow-circle');
            existingCircles.forEach(circle => circle.remove());

            const rect = mapContainer.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const closestPlanet = findClosestPlanet(x, y);
            
            if (closestPlanet) {
                createStickerSelectionBox(closestPlanet);
            }
        };

        function displaySticker(planetName, planet) {
            const scaledX = planet.x * scaleX + 3.2;
            const scaledY = planet.y * scaleY;
            
            const stickerPath = getStickerPath(planet.status);
            const sticker = document.createElement('img');
            sticker.src = stickerPath;
            sticker.className = 'planet-sticker';
            sticker.dataset.planet = planetName;
            sticker.style.position = 'absolute';
            sticker.style.width = '35px';
            sticker.style.height = '35px';
            sticker.style.left = `${scaledX}px`;
            sticker.style.top = `${scaledY}px`;
            mapContainer.appendChild(sticker);
        }

        function getStickerPath(status) {
            const paths = {
                'rebel presence': '/static/stickers/rebel_pres.png',
                'empire presence': '/static/stickers/empire_pres.png',
                'rebel base': '/static/stickers/rebel_base.png',
                'empire base': '/static/stickers/empire_base.png'
            };
            return paths[status];
        }

        function findClosestPlanet(clickX, clickY, maxDistance = 50) {
            for (const [name, planet] of Object.entries(planets)) {
                const scaledX = planet.x * scaleX + offsetX;
                const scaledY = planet.y * scaleY + offsetY;
                
                const distance = Math.sqrt(
                    Math.pow(clickX - scaledX, 2) + 
                    Math.pow(clickY - scaledY, 2)
                );
                
                if (distance <= maxDistance) {
                    return { name, ...planet };
                }
            }
            return null;
        }

        function createStickerSelectionBox(planet) {
            const box = document.createElement('div');
            box.className = 'sticker-selection-box';
            box.style.position = 'absolute';
            box.style.border = '1px solid black';
            box.style.backgroundColor = 'white';
            box.style.padding = '10px';
            box.style.display = 'flex';
            box.style.gap = '10px';

            const scaledX = planet.x * scaleX + offsetX;
            const scaledY = planet.y * scaleY + offsetY;

            // Position box based on right/bottom flags
            const boxWidth = 160; // Approximate width of selection box
            const boxHeight = 50; // Approximate height of selection box
            const spacing = 20; // Space between box and planet

            box.style.left = planet.right ? 
            `${scaledX - boxWidth - spacing}px` : 
            `${scaledX + spacing}px`;
            box.style.top = planet.bottom ? 
            `${scaledY - boxHeight - spacing - 30}px` : 
            `${scaledY + spacing}px`;

            // Create a glowing circle around the planet
            const glowCircle = document.createElement('div');
            glowCircle.className = 'glow-circle';
            glowCircle.style.position = 'absolute';
            glowCircle.style.width = '33.5px';   // Adjust size as needed
            glowCircle.style.height = '33.5px';
            glowCircle.style.borderRadius = '50%';
            glowCircle.style.border = '2px solid yellow';
            glowCircle.style.boxShadow = '0px 0px 15px 5px yellow';
            glowCircle.style.left = `${scaledX - 20}px`;  // Centered around planet
            glowCircle.style.top = `${scaledY - 18}px`;
            
            mapContainer.appendChild(glowCircle);

            const stickers = [
                { name: 'Neutral', path: '/static/stickers/neutral.png' },
                { name: 'Empire Base', path: '/static/stickers/empire_base.png' },
                { name: 'Empire Presence', path: '/static/stickers/empire_pres.png' },
                { name: 'Rebel Base', path: '/static/stickers/rebel_base.png' },
                { name: 'Rebel Presence', path: '/static/stickers/rebel_pres.png' }
            ];

            stickers.forEach(stickerType => {
                const stickerWrapper = document.createElement('div');
                stickerWrapper.style.display = 'flex';
                stickerWrapper.style.flexDirection = 'column';
                stickerWrapper.style.alignItems = 'center';
                stickerWrapper.style.width = '35px';  // Fixed width to maintain uniform layout

                const stickerOption = document.createElement('img');
                stickerOption.src = stickerType.path;
                stickerOption.style.width = '35px';
                stickerOption.style.height = '35px';
                stickerOption.style.cursor = 'pointer';

                stickerOption.onclick = () => {
                    updatePlanetSticker(planet.name, stickerType.name.toLowerCase());

                    const existingSticker = document.querySelector(`[data-planet="${planet.name}"]`);
                    if (existingSticker) {
                        existingSticker.remove();
                    }

                    if (stickerType.name.toLowerCase() !== 'neutral') {
                        const newSticker = document.createElement('img');
                        newSticker.src = stickerType.path;
                        newSticker.className = 'planet-sticker';
                        newSticker.dataset.planet = planet.name;
                        newSticker.style.position = 'absolute';
                        newSticker.style.width = '35px';
                        newSticker.style.height = '35px';
                        newSticker.style.left = `${scaledX - 15}px`;
                        newSticker.style.top = `${scaledY - 15}px`;
                        mapContainer.appendChild(newSticker);
                    }

                    box.remove();
                    glowCircle.remove(); // Remove glow when selection box closes
                };

                const stickerLabel = document.createElement('div');
                stickerLabel.textContent = stickerType.name;
                stickerLabel.style.fontSize = '10px';
                stickerLabel.style.textAlign = 'center';
                stickerLabel.style.fontFamily = '"Gill Sans", sans-serif'; // change font here

                stickerWrapper.appendChild(stickerOption);
                stickerWrapper.appendChild(stickerLabel);
                box.appendChild(stickerWrapper);
            });

            mapContainer.appendChild(box);
        }

        function updatePlanetSticker(planetName, status) {
            const data = {
                planet: planetName,
                status: status
            };
            console.log('Sending data:', data);  // Debug log
            
            fetch('/update_planet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
        }
    </script>
</body>
</html>